-- Populate the dimension table
MERGE INTO AIRBYTE_DATABASE.ANALYTICS.DIM_FILM AS TARGET
USING (
  SELECT 
    F.FILM_ID,
    F.TITLE,
    F.RELEASE_YEAR,
    F.LENGTH,
    F.RATING,
    F.RENTAL_RATE,
    F.REPLACEMENT_COST,
    CAT.NAME AS CATEGORY
  FROM AIRBYTE_RAW_DATA.FILM F
  LEFT JOIN AIRBYTE_RAW_DATA.FILM_CATEGORY FC ON F.FILM_ID = FC.FILM_ID
  LEFT JOIN AIRBYTE_RAW_DATA.CATEGORY CAT ON FC.CATEGORY_ID = CAT.CATEGORY_ID
) AS SOURCE
ON TARGET.FILM_ID = SOURCE.FILM_ID
WHEN MATCHED THEN 
  UPDATE SET 
    TITLE = SOURCE.TITLE,
    RELEASE_YEAR = SOURCE.RELEASE_YEAR,
    LENGTH = SOURCE.LENGTH,
    RATING = SOURCE.RATING,
    RENTAL_RATE = SOURCE.RENTAL_RATE,
    REPLACEMENT_COST = SOURCE.REPLACEMENT_COST,
    CATEGORY = SOURCE.CATEGORY
WHEN NOT MATCHED THEN 
  INSERT (
    FILM_ID, TITLE, RELEASE_YEAR, LENGTH, RATING,
    RENTAL_RATE, REPLACEMENT_COST, CATEGORY
  )
  VALUES (
    SOURCE.FILM_ID, SOURCE.TITLE, SOURCE.RELEASE_YEAR, SOURCE.LENGTH,
    SOURCE.RATING, SOURCE.RENTAL_RATE, SOURCE.REPLACEMENT_COST, SOURCE.CATEGORY
  );

-- Verify table was created and populated
SELECT COUNT(*) AS FILM_COUNT FROM AIRBYTE_DATABASE.ANALYTICS.DIM_FILM;
